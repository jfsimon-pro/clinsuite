generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id           String   @id @default(uuid())
  name         String
  cnpj         String   @unique
  logoUrl      String?
  primaryColor String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  units        Unit[]
  funnels      Funnel[]
  leads        Lead[]
  users        User[]
  whatsappConnections WhatsAppConnection[]
  taskRules    StageTaskRule[]
  tasks        Task[]
  whatsappConfig WhatsAppConfig?
  tags         Tag[]
}

model WhatsAppConfig {
  id            String   @id @default(uuid())
  companyId     String   @unique
  phoneNumberId String
  wabaId        String
  accessToken   String   // Token permanente
  verifyToken   String   // Token para webhook
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Unit {
  id          String   @id @default(uuid())
  name        String
  code        String?
  address     String?
  phone       String?
  email       String?
  companyId   String
  managerId   String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager     User?    @relation("UnitManager", fields: [managerId], references: [id], onDelete: SetNull)
  funnels     Funnel[]
  leads       Lead[]
  users       User[]   @relation("UnitUsers")

  @@unique([companyId, code])
}

model User {
  id        String        @id @default(uuid())
  email     String        @unique
  password  String
  name      String
  role      Role
  specialty UserSpecialty @default(GENERAL)
  companyId String
  unitId    String?
  createdAt DateTime      @default(now())
  leads     Lead[]        @relation("LeadOwner")
  dentistLeads Lead[]     @relation("LeadDentist")
  leadNotes LeadNote[]
  reminders Reminder[]
  assignedTaskRules StageTaskRule[] @relation("TaskRuleAssignedUser")
  assignedTasks     Task[]          @relation("TaskAssigned")
  completedTasks    Task[]          @relation("TaskCompletedBy")
  consultas         Consulta[]      @relation("ConsultaDentist")
  documentosUpload  Documento[]     @relation("DocumentUploader")
  prescricoes       Prescricao[]    @relation("PrescricaoDentist")
  company   Company       @relation(fields: [companyId], references: [id])
  unit      Unit?         @relation("UnitUsers", fields: [unitId], references: [id], onDelete: SetNull)
  managedUnits Unit[]     @relation("UnitManager")
}

model Funnel {
  id        String       @id @default(uuid())
  name      String
  companyId String
  unitId    String?
  createdAt DateTime     @default(now())
  company   Company      @relation(fields: [companyId], references: [id])
  unit      Unit?        @relation(fields: [unitId], references: [id], onDelete: SetNull)
  steps     FunnelStep[]
  leads     Lead[]
}

model FunnelStep {
  id       String         @id @default(uuid())
  name     String
  order    Int
  funnelId String
  funnel   Funnel         @relation(fields: [funnelId], references: [id], onDelete: Cascade)
  leads    Lead[]
  rules    ReminderRule[]
  taskRules StageTaskRule[]

  // NOVOS CAMPOS PARA ANALYTICS
  tipoEtapa             TipoEtapa               @default(QUALIFICACAO)
  tipoConceitual        TipoEtapaConceitual     @default(CAPTACAO) // Campo principal para relat√≥rios universais
  metaConversao         Float?                  // Meta de convers√£o para pr√≥xima etapa (%)
  tempoMedioEtapa       Int?                    // Tempo m√©dio em dias
  valorMedioEtapa       Decimal?                // Valor m√©dio dos leads nesta etapa
  corEtapa              String?                 // Cor para visualiza√ß√£o
  iconEtapa             String?                 // √çcone para visualiza√ß√£o
}

model Lead {
  id                    String              @id @default(uuid())
  phone                 String              // OBRIGAT√ìRIO - √∫nico campo necess√°rio para criar
  name                  String?             // Opcional - pode ser adicionado depois
  funnelId              String
  stepId                String
  responsibleId         String?             // Opcional - pode n√£o ter respons√°vel inicialmente
  dentistaId            String?             // Opcional - dentista respons√°vel pelo lead
  companyId             String
  unitId                String?             // NOVO - unidade do lead

  // Campos de neg√≥cio
  valorVenda            Decimal?            // Valor da venda em R$
  dataConsulta          DateTime?           // Data e hora da consulta
  duracaoConsulta       Int?                // Dura√ß√£o da consulta em minutos (padr√£o 60)
  tipoProcura           TipoProcura?        // Dropdown
  meioCaptacao          MeioCaptacao?       // Dropdown
  closerNegociacao      String?             // Nome do colaborador closer de negocia√ß√£o
  closerFollow          String?             // Nome do colaborador closer de follow
  dentista              Dentista?           // Dropdown (DEPRECATED - usar dentistaId)
  motivoPerda           MotivoPerda?        // Dropdown
  dentistaParticipou    DentistaParticipou? // Dropdown
  previsaoFechamento    DateTime?           // Data de previs√£o
  objecao               Objecao?            // Dropdown
  observacoes           String?             // Campo de texto grande

  // NOVOS CAMPOS PARA ANALYTICS
  statusVenda           StatusVenda         @default(QUALIFICANDO)
  valorOrcamento        Decimal?            // Valor inicial or√ßado
  dataOrcamento         DateTime?           // Quando foi or√ßado
  dataFechamento        DateTime?           // Quando fechou/perdeu
  valorDesconto         Decimal?            // Desconto aplicado (valorOrcamento - valorVenda)
  probabilidadeFecho    Int?                // % de probabilidade (0-100)
  
  // DADOS PESSOAIS E CONTATO
  email                 String?
  cpf                   String?
  dataNascimento        DateTime?
  endereco              String?
  cidade                String?
  estado                String?
  cep                   String?
  contatoEmergencia     String?
  nomeContatoEmergencia String?
  
  // ANAMNESE (Hist√≥ria M√©dica) - armazenado como JSON para flexibilidade
  anamnese              Json?               // { alergias: [], medicamentos: [], doencas: [], ... }
  
  // PORTAL DO PACIENTE - Autentica√ß√£o
  password              String?             // Hash da senha (bcrypt) - s√≥ pacientes t√™m
  emailVerified         Boolean             @default(false) // Se o email foi verificado
  verificationToken     String?             // Token de verifica√ß√£o de email
  resetPasswordToken    String?             // Token para resetar senha
  resetPasswordExpires  DateTime?           // Expira√ß√£o do token de reset
  lastLogin             DateTime?           // √öltimo acesso ao portal
  portalEnabled         Boolean             @default(false) // Se pode acessar o portal
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relacionamentos
  company               Company             @relation(fields: [companyId], references: [id])
  funnel                Funnel              @relation(fields: [funnelId], references: [id])
  responsible           User?               @relation("LeadOwner", fields: [responsibleId], references: [id])
  dentistUser           User?               @relation("LeadDentist", fields: [dentistaId], references: [id])
  step                  FunnelStep          @relation(fields: [stepId], references: [id], onDelete: Cascade)
  unit                  Unit?               @relation(fields: [unitId], references: [id], onDelete: SetNull)
  notes                 LeadNote[]
  reminders             Reminder[]
  tasks                 Task[]
  consultas             Consulta[]
  documentos            Documento[]
  odontograma           Odontograma?
  pagamentos            Pagamento[]
  prescricoes           Prescricao[]
  tags                  TagOnLead[]
}

// Sistema de Tags Inteligentes
model Tag {
  id          String      @id @default(uuid())
  name        String      // Nome da tag (ex: "Implante", "Or√ßamento Alto", "Quente")
  color       String      @default("#6366F1") // Cor hex para exibi√ß√£o
  icon        String?     // Emoji ou √≠cone (ex: "üî•", "üí∞", "ü¶∑")
  description String?     // Descri√ß√£o opcional
  companyId   String
  isSystem    Boolean     @default(false) // Tags padr√£o do sistema vs customizadas
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  leads       TagOnLead[]
  
  @@unique([companyId, name]) // Nome √∫nico por empresa
}

// Tabela de jun√ß√£o para rela√ß√£o many-to-many Lead <-> Tag
model TagOnLead {
  id        String   @id @default(uuid())
  leadId    String
  tagId     String
  addedAt   DateTime @default(now())
  addedBy   String?  // ID do usu√°rio que adicionou a tag
  
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([leadId, tagId]) // Evitar duplicatas
  @@index([leadId])
  @@index([tagId])
}

model LeadNote {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  leadId    String
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model ReminderRule {
  id        String     @id @default(uuid())
  stepId    String
  delayDays Int
  step      FunnelStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
}

model Reminder {
  id        String   @id @default(uuid())
  leadId    String
  userId    String
  dueDate   DateTime
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
}

// Sistema de Tarefas Autom√°ticas
model StageTaskRule {
  id             String    @id @default(uuid())
  stepId         String    // FK para FunnelStep
  name           String    // "Ligar para o lead"
  description    String?   // Instru√ß√µes detalhadas
  order          Int       // Ordem na sequ√™ncia (1, 2, 3...)
  delayDays      Int       // Prazo em dias
  delayType      DelayType @default(ABSOLUTE)
  assignType     AssignType @default(LEAD_OWNER)
  assignedUserId String?   // Se FIXED_USER
  isActive       Boolean   @default(true)
  companyId      String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  // Relacionamentos
  step           FunnelStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  assignedUser   User?      @relation("TaskRuleAssignedUser", fields: [assignedUserId], references: [id])
  company        Company    @relation(fields: [companyId], references: [id])
  tasks          Task[]
  
  @@unique([stepId, order]) // Ordem √∫nica por etapa
}

model Task {
  id             String     @id @default(uuid())
  leadId         String
  ruleId         String     // Qual regra gerou esta tarefa
  assignedId     String     // Usu√°rio respons√°vel
  title          String
  description    String?
  dueDate        DateTime
  status         TaskStatus @default(PENDING)
  completedAt    DateTime?
  completedBy    String?    // Quem marcou como conclu√≠da
  notes          String?    // Observa√ß√µes na conclus√£o
  companyId      String
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  
  // Relacionamentos
  lead           Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  rule           StageTaskRule    @relation(fields: [ruleId], references: [id])
  assigned       User             @relation("TaskAssigned", fields: [assignedId], references: [id])
  completedByUser User?           @relation("TaskCompletedBy", fields: [completedBy], references: [id])
  company        Company          @relation(fields: [companyId], references: [id])
}

enum Role {
  SUPER_ADMIN
  ADMIN
  WORKER
  DENTIST
}

enum UserSpecialty {
  GENERAL
  CLOSER_NEGOCIACAO
  CLOSER_FOLLOW
}

// Enums para Sistema de Tarefas
enum DelayType {
  ABSOLUTE      // X dias ap√≥s lead entrar na etapa
  AFTER_PREVIOUS // X dias ap√≥s tarefa anterior ser conclu√≠da
}

enum AssignType {
  LEAD_OWNER    // Respons√°vel atual do lead
  FIXED_USER    // Usu√°rio espec√≠fico
  ROUND_ROBIN   // Distribui√ß√£o autom√°tica (futura implementa√ß√£o)
}

enum TaskStatus {
  PENDING
  COMPLETED
  EXPIRED
  CANCELLED
}

enum TipoProcura {
  ORTODONTIA
  IMPLANTE
  ESTETICA
  LIMPEZA
  CANAL
  EXTRACAO
  PROTESE
  CLAREAMENTO
  OUTROS
}

enum MeioCaptacao {
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  GOOGLE_ADS
  INDICACAO
  SITE
  TELEFONE
  PRESENCIAL
  OUTROS
}


enum Dentista {
  IANARA
  DENTISTA_1
  DENTISTA_2
  DENTISTA_3
  OUTROS
}

enum MotivoPerda {
  PRECO
  TEMPO
  LOCALIZACAO
  CONFIANCA
  CONCORRENCIA
  NAO_INTERESSADO
  NAO_RESPONDEU
  OUTROS
}

enum DentistaParticipou {
  SIM
  NAO
}

enum Objecao {
  PRECO_ALTO
  TEMPO_TRATAMENTO
  DOR_MEDO
  SEGUNDA_OPINIAO
  PENSANDO
  CONVERSAR_FAMILIA
  CONDICOES_PAGAMENTO
  OUTROS
}

// NOVOS ENUMS PARA ANALYTICS
enum StatusVenda {
  QUALIFICANDO          // Ainda conhecendo o lead
  INTERESSE_DEMONSTRADO // Demonstrou interesse
  CONSULTA_AGENDADA     // Marcou consulta
  CONSULTA_REALIZADA    // Compareceu na consulta
  ORCAMENTO_ENVIADO     // Recebeu proposta
  NEGOCIACAO            // Discutindo pre√ßo/condi√ß√µes
  GANHO                 // Fechou a venda
  PERDIDO               // Perdeu a venda
  PAUSADO               // Lead pausado temporariamente
}

enum TipoEtapa {
  CAPTACAO              // Capta√ß√£o de leads
  QUALIFICACAO          // Qualifica√ß√£o inicial
  AGENDAMENTO           // Agendamento de consultas
  ATENDIMENTO           // Consultas e atendimentos
  ORCAMENTO             // Envio de or√ßamentos
  NEGOCIACAO            // Negocia√ß√£o de pre√ßos
  FECHAMENTO            // Fechamento da venda
  POS_VENDA             // P√≥s-venda e fideliza√ß√£o
}

// ENUM PARA SISTEMA H√çBRIDO DE RELAT√ìRIOS UNIVERSAIS
enum TipoEtapaConceitual {
  CAPTACAO              // Gera√ß√£o inicial de leads (WhatsApp, Site, Indica√ß√£o)
  QUALIFICACAO          // Valida√ß√£o de interesse/necessidade (Triagem, Qualifica√ß√£o)
  APRESENTACAO          // Consultas e avalia√ß√µes (Primeira Consulta, Exames)
  PROPOSTA              // Or√ßamentos e planos de tratamento (Or√ßamento, Plano)
  NEGOCIACAO            // Discuss√£o de valores/condi√ß√µes (Negocia√ß√£o, Aprova√ß√£o)
  FECHAMENTO            // Decis√£o final (Ganho/Perdido, Contrato, Agendamento)
}

// WhatsApp Models
model WhatsAppConnection {
  id          String   @id @default(uuid())
  name        String
  phone       String?
  status      WhatsAppStatus @default(DISCONNECTED)
  companyId   String
  sessionId   String?  // ID da sess√£o do VenomBot
  qrCode      String?  // QR Code em base64
  lastSeen    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos
  company     Company  @relation(fields: [companyId], references: [id])
  chats       WhatsAppChat[]
  messages    WhatsAppMessage[]
}

model WhatsAppChat {
  id                    String   @id @default(uuid())
  connectionId          String
  contactId             String   // ID do contato no WhatsApp
  contactName           String?
  contactPhone          String
  isGroup               Boolean  @default(false)
  lastMessage           String?
  lastMessageTime       DateTime?
  unreadCount           Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relacionamentos
  connection            WhatsAppConnection @relation(fields: [connectionId], references: [id])
  messages              WhatsAppMessage[]
}

model WhatsAppMessage {
  id            String   @id @default(uuid())
  connectionId  String
  chatId        String
  messageId     String   // ID da mensagem no WhatsApp
  content       String
  type          MessageType @default(TEXT)
  fromMe        Boolean  @default(false)
  timestamp     DateTime
  status        MessageStatus @default(SENT)
  createdAt     DateTime @default(now())
  
  // Relacionamentos
  connection    WhatsAppConnection @relation(fields: [connectionId], references: [id])
  chat          WhatsAppChat       @relation(fields: [chatId], references: [id])
}

enum WhatsAppStatus {
  CONNECTED
  DISCONNECTED
  CONNECTING
  ERROR
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
  LOCATION
  CONTACT
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  ERROR
}

// ============================================
// SISTEMA DE PRONTU√ÅRIO ODONTOL√ìGICO
// ============================================

model Consulta {
  id                String    @id @default(uuid())
  leadId            String
  dentistaId        String
  dataConsulta      DateTime
  duracao           Int       @default(60)
  procedimentos     String[]  // Array de procedimentos realizados
  dentesAtendidos   Int[]     // N√∫meros dos dentes (1-32)
  anestesiaUsada    String?
  materiaisUsados   String?
  observacoes       String?
  compareceu        Boolean   @default(true)
  valorCobrado      Decimal?
  proximaConsulta   DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  lead              Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  dentista          User      @relation("ConsultaDentist", fields: [dentistaId], references: [id])
  prescricoes       Prescricao[]
}

model Documento {
  id           String          @id @default(uuid())
  leadId       String
  tipo         TipoDocumento
  categoria    String?         // "Intraoral", "Panor√¢mica", "Termo de Consentimento"
  url          String
  descricao    String?
  uploadedBy   String
  createdAt    DateTime        @default(now())
  
  lead         Lead            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  uploader     User            @relation("DocumentUploader", fields: [uploadedBy], references: [id])
}

model Odontograma {
  id        String   @id @default(uuid())
  leadId    String   @unique
  dentes    Json     // { "1": { status: "CARIE", obs: "..." }, "2": { status: "HIGIDO" }, ... }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model Pagamento {
  id              String            @id @default(uuid())
  leadId          String
  valor           Decimal
  formaPagamento  FormaPagamento
  dataVencimento  DateTime
  dataPagamento   DateTime?
  status          StatusPagamento   @default(PENDENTE)
  numeroParcela   Int?
  totalParcelas   Int?
  observacoes     String?
  createdAt       DateTime          @default(now())
  
  lead            Lead              @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model Prescricao {
  id            String    @id @default(uuid())
  consultaId    String
  leadId        String
  dentistaId    String
  medicamentos  Json      // [{ nome, dose, frequencia, duracao, obs }]
  observacoes   String?
  createdAt     DateTime  @default(now())
  
  consulta      Consulta  @relation(fields: [consultaId], references: [id], onDelete: Cascade)
  lead          Lead      @relation(fields: [leadId], references: [id])
  dentista      User      @relation("PrescricaoDentist", fields: [dentistaId], references: [id])
}

// Enums para Prontu√°rio
enum TipoDocumento {
  FOTO
  RAIO_X
  PDF
}

enum FormaPagamento {
  DINHEIRO
  CARTAO_DEBITO
  CARTAO_CREDITO
  PIX
  TRANSFERENCIA
  PARCELADO
}

enum StatusPagamento {
  PENDENTE
  PAGO
  ATRASADO
  CANCELADO
}
